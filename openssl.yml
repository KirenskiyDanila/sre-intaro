---

- name: Wget source code
  get_url:
    url: https://www.openssl.org/source/openssl-1.1.1t.tar.gz
    dest: /tmp
    validate_certs: false
  become: yes

- name: Extract downloaded file
  unarchive:
    src: /tmp/openssl-1.1.1t.tar.gz
    dest: /tmp
    remote_src: yes
  become: yes

- name: Configure OpenSSL
  command:
    cmd:  ./config --prefix=/usr/local/openssl --openssldir=/usr/local/openssl
    chdir: /tmp/openssl-1.1.1t
  become: yes

- name: Build OpenSSL
  command:
    cmd: make -j $(nproc)
    chdir: /tmp/openssl-1.1.1t
  become: yes
  ignore_errors: true

- name: Install OpenSSL
  make:
    chdir: /tmp/openssl-1.1.1t
    target: install
  become: yes

- name: Update the shared libraries cache
  command:
    cmd: ldconfig
    chdir: /tmp/openssl-1.1.1t
  become: yes

- name: Update system-wide OpenSSL config
  template:
    src: /etc/ansible/files/openssl.sh
    dest: /etc/profile.d
    mode: 0644
  become: yes
